<!DOCTYPE html>  <html> <head>   <title>index.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               index.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>SVG Cleaner</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Cleaning SVG Files - A port of Scour to JavaScript</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>About the port</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The goal of the Scour port was to keep the ideas and way how Scour cleans SVG files.
I translated most of the processing steps and copied most of the original comments
from scour into the new source code, as they describe the original ideas best.
I marked all of these orginial comments by putting 'Scour:' in the first line an
used the markdown syntax for quotes (>). </p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <ul>
<li>Missing processing steps are marked with an comment '@missing'.</li>
<li>Changed processing steps are marked with an comment containern '@extened' or '@changed'</li>
<li>Some functions and variable names are changed to (hopefully) be more descriptive.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>Original Notes from Scour</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Scour:</p>

<blockquote>
  <p>Notes:</p>
  
  <p>rubys' path-crunching ideas here: <a href="">http://intertwingly.net/code/svgtidy/spec.rb</a>
  (and implemented here: http://intertwingly.net/code/svgtidy/svgtidy.rb )</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <blockquote>
  <p>Yet more ideas here: <a href="http://wiki.inkscape.org/wiki/index.php/Save_Cleaned_SVG">Inkscape Wiki</a></p>
  
  <ul>
  <li>Process Transformations
  <ul><li>Collapse all group based transformations</li></ul></li>
  </ul>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <blockquote>
  <p>Even more ideas here: <a href="">http://esw.w3.org/topic/SvgTidy</a></p>
  
  <ul>
  <li>analysis of path elements to see if rect can be used instead? (must also need to look
  at rounded corners)</li>
  </ul>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <blockquote>
  <p>Next Up:</p>
  
  <ul>
  <li>why are marker-start, -end not removed from the style attribute?</li>
  <li>why are only overflow style properties considered and not attributes?</li>
  <li>only remove unreferenced elements if they are not children of a referenced element</li>
  <li>add an option to remove ids if they match the Inkscape-style of IDs</li>
  <li>investigate point-reducing algorithms</li>
  <li>parse transform attribute</li>
  <li>if a <g> has only one element in it, collapse the <g> (ensure transform, etc are carried down)</li>
  </ul>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>Implementation</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">cheerio</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cheerio&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">CSSOM</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cssom&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">$</span>
  <span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Namespace Prefixes that should be removed</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">namespacePrefixes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dc&#39;</span><span class="p">,</span> <span class="s1">&#39;rdf&#39;</span><span class="p">,</span> <span class="s1">&#39;sodipodi&#39;</span><span class="p">,</span> <span class="s1">&#39;cc&#39;</span><span class="p">,</span> <span class="s1">&#39;inkscape&#39;</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h2>Sanitize References</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Scour:
Removes the unreferenced ID attributes.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">removeUnreferencedIDs</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">identifiedElements</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;[id]&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">referencedIDs</span> <span class="o">=</span> <span class="nx">findReferencedElements</span><span class="p">();</span>
  <span class="nx">_</span><span class="p">(</span><span class="nx">identifiedElements</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="err">Â </span><span class="p">{</span>
      <span class="kd">var</span> <span class="nx">$node</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">$node</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">(</span><span class="nx">referencedIDs</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">$node</span><span class="p">.</span><span class="nx">removeAttr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
      <span class="p">};</span>
  <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Style-Properties and Element-Attributes that might contain an id, a reference to another object</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">referencingProperties</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="s1">&#39;clip-path&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">,</span>  <span class="s1">&#39;marker-start&#39;</span><span class="p">,</span> <span class="s1">&#39;marker-end&#39;</span><span class="p">,</span> <span class="s1">&#39;marker-mid&#39;</span><span class="p">];</span>

<span class="kd">function</span> <span class="nx">addReferencingElement</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/#/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">(</span><span class="nx">ids</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">ids</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">}</span>

  <span class="nx">ids</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">ids</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>extracts #id out of CSS url('#id')</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">extractReferencedId</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\s]/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\s]/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[&quot;&#39;]/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Scour:</p>

<blockquote>
  <p>Returns the number of times an ID is referenced as well as all elements
  that reference it.  node is the node at which to start the search.  The
  return value is a map which has the id as key and each value is an array
  where the first value is a count and the second value is a list of nodes
  that referenced it.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">findReferencedElements</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">ids</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="nx">_</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">$node</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;style&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">styles</span> <span class="o">=</span> <span class="nx">CSSOM</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">$node</span><span class="p">.</span><span class="nx">text</span><span class="p">());</span>
      <span class="nx">_</span><span class="p">(</span><span class="nx">styles</span><span class="p">.</span><span class="nx">cssRules</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">rule</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">(</span><span class="nx">referencingProperties</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">referencingProperty</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">style</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="nx">referencingProperty</span><span class="p">))</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">extractReferencedId</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">referencingProperty</span><span class="p">]);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">addReferencingElement</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>if xlink:href is set, then grab the id</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">href</span> <span class="o">=</span> <span class="nx">$node</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;xlink:href&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">href</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">addReferencingElement</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">href</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>now get all style properties</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">styles</span> <span class="o">=</span> <span class="nx">parseStyles</span><span class="p">(</span><span class="nx">$node</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">));</span>

    <span class="nx">_</span><span class="p">(</span><span class="nx">referencingProperties</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">referencingProperty</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">$node</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="nx">referencingProperty</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">extractReferencedId</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">addReferencingElement</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="nx">styles</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="nx">referencingProperty</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">extractReferencedId</span><span class="p">(</span><span class="nx">styles</span><span class="p">[</span><span class="nx">referencingProperty</span><span class="p">]);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">addReferencingElement</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">});</span>

  <span class="p">});</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ids</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">ids</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>scour:</p>

<blockquote>
  <p>removes all unreferenced elements except for <code>&lt;svg&gt;, &lt;font&gt;, &lt;metadata&gt;, &lt;title&gt;, and &lt;desc&gt;</code>.
  Also vacuums the defs of any non-referenced renderable elements.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">removeUnreferencedElements</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">referencedIDs</span> <span class="o">=</span> <span class="nx">findReferencedElements</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">alwaysKeepTags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">];</span>
  <span class="kd">function</span> <span class="nx">removeUnreferencedElementsInTag</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">children</span><span class="p">()).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>scour:</p>

<blockquote>
  <p>we only remove if it is not one of our tags we always keep (see above)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="nx">alwaysKeepTags</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">$node</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">$node</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">(</span><span class="nx">referencedIDs</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>scour:</p>

<blockquote>
  <p>we only inspect the children of a group in a defs if the group
  is not referenced anywhere else</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">removeUnreferencedElementsInTag</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span><span class="err">Â </span><span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>scour:</p>

<blockquote>
  <p>Remove most unreferenced elements inside defs</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;defs&#39;</span><span class="p">)).</span><span class="nx">each</span><span class="p">(</span><span class="nx">removeUnreferencedElementsInTag</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>scour:</p>

<blockquote>
  <p>Remove certain unreferenced elements outside of defs</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">identifiedElements</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;* &gt; linearGradient[id], * &gt; radialGradient[id], * &gt; pattern[id]&#39;</span><span class="p">);</span>
  
  <span class="nx">_</span><span class="p">(</span><span class="nx">identifiedElements</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">(</span><span class="nx">referencedIDs</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>

<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h2>Namspace</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">removeNamespacedElements</span><span class="p">(</span><span class="nx">namespacesToRemove</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">namespacedElements</span> <span class="o">=</span> <span class="nx">_</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="kd">var</span> <span class="nx">$node</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">$node</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;tag&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">namespaceTagName</span> <span class="o">=</span> <span class="nx">$node</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">namespaceTagName</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">namespacesToRemove</span><span class="p">,</span> <span class="nx">namespaceTagName</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">$</span><span class="p">(</span><span class="nx">namespacedElements</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>

<span class="p">}</span>

<span class="kd">function</span> <span class="nx">removeNamespacedAttributes</span><span class="p">(</span><span class="nx">namespacesToRemove</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ix</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attribs</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">namespaceAtrributeName</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">namespaceAtrributeName</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">namespacesToRemove</span><span class="p">,</span> <span class="nx">namespaceAtrributeName</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">removeAttr</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>

<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <h2>Comments</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">removeComments</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">commentNodes</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>process on NODE level</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">searchForComment</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;comment&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">commentNodes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">).</span><span class="nx">isUndefined</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span> <span class="nx">searchForComment</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">searchForComment</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">_root</span><span class="p">);</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">commentNodes</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h2>Repair Style</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">mayContainTextNode</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">elementsThatDontContainText</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">,</span> <span class="s1">&#39;circle&#39;</span><span class="p">,</span> <span class="s1">&#39;ellipse&#39;</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;polygon&#39;</span><span class="p">,</span> <span class="s1">&#39;polyline&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">elementsThatCouldContainText</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;clipPath&#39;</span><span class="p">,</span> <span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">,</span> <span class="s1">&#39;linearGradient&#39;</span><span class="p">,</span> <span class="s1">&#39;radialGradient&#39;</span><span class="p">,</span> <span class="s1">&#39;symbol&#39;</span><span class="p">];</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;comment&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="nx">elementsThatDontContainText</span><span class="p">).</span><span class="nx">include</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="nx">elementsThatCouldContainText</span><span class="p">).</span><span class="nx">include</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">).</span><span class="nx">isUndefined</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">_</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">).</span><span class="nx">any</span><span class="p">(</span><span class="nx">mayContainTextNode</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>

<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>returns a float without the unit</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">styleValue</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[^-\d\.]/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">));</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>removes properties, by a given list of keys</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">removeStyleProperties</span><span class="p">(</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">properties</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">_</span><span class="p">(</span><span class="nx">styles</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="nx">properties</span><span class="p">).</span><span class="nx">include</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">delete</span> <span class="nx">styles</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">styles</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>a simple CSS parser, returns object with {property: value}</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">parseStyles</span><span class="p">(</span><span class="nx">inlineStyles</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">styles</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">inlineStyles</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">styles</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">styleRules</span> <span class="o">=</span> <span class="nx">inlineStyles</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">);</span>
  <span class="nx">_</span><span class="p">(</span><span class="nx">styleRules</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">style</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">keyValue</span> <span class="o">=</span> <span class="nx">style</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">keyValue</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">styles</span><span class="p">[</span><span class="nx">keyValue</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\s]/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">keyValue</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">styles</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">renderStyles</span><span class="p">(</span><span class="nx">styles</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">(</span><span class="nx">styles</span><span class="p">).</span><span class="nx">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">inlineStyles</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">styles</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">inlineStyles</span> <span class="o">+=</span> <span class="nx">value</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">property</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">inlineStyles</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">repairStyles</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ix</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">repairStyle</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">repairStyle</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="err">Â </span><span class="p">{</span>

  <span class="kd">var</span> <span class="nx">$node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">styles</span> <span class="o">=</span> <span class="nx">parseStyles</span><span class="p">(</span><span class="nx">$node</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">));</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">(</span><span class="nx">styles</span><span class="p">).</span><span class="nx">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>scour:</p>

<blockquote>
  <p>I've seen this enough to know that I need to correct it:
  <code>fill: url(#linearGradient4918) rgb(0, 0, 0);</code></p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">([</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">(</span><span class="nx">styles</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="nx">property</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">styles</span><span class="p">[</span><span class="nx">property</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;) &#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nx">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;url(#&#39;</span> <span class="o">||</span> <span class="nx">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;url(&quot;#&#39;</span> <span class="o">||</span> <span class="nx">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;url(&#39;#&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rgb(0, 0, 0)&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">styles</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="kd">var</span> <span class="nx">STYLE_PROPERTIES</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nx">STYLE_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;stroke&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;stroke&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke-width&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke-linejoin&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke-opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke-miterlimit&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke-linecap&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke-dasharray&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke-dashoffset&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke-opacity&#39;</span><span class="p">];</span>
  <span class="nx">STYLE_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="s1">&#39;fill-opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;fill-rule&#39;</span><span class="p">];</span>
  <span class="nx">STYLE_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;font-family&#39;</span><span class="p">,</span> <span class="s1">&#39;font-size&#39;</span><span class="p">,</span> <span class="s1">&#39;font-stretch&#39;</span><span class="p">,</span> <span class="s1">&#39;font-size-adjust&#39;</span><span class="p">,</span> <span class="s1">&#39;font-style&#39;</span><span class="p">,</span> <span class="s1">&#39;font-variant&#39;</span><span class="p">,</span> <span class="s1">&#39;font-weight&#39;</span><span class="p">,</span> <span class="s1">&#39;letter-spacing&#39;</span><span class="p">,</span> <span class="s1">&#39;line-height&#39;</span><span class="p">,</span> <span class="s1">&#39;kerning&#39;</span><span class="p">,</span> <span class="s1">&#39;text-align&#39;</span><span class="p">,</span> <span class="s1">&#39;text-anchor&#39;</span><span class="p">,</span> <span class="s1">&#39;text-decoration&#39;</span><span class="p">,</span> <span class="s1">&#39;text-rendering&#39;</span><span class="p">,</span> <span class="s1">&#39;unicode-bidi&#39;</span><span class="p">,</span> <span class="s1">&#39;word-spacing&#39;</span><span class="p">,</span> <span class="s1">&#39;writing-mode&#39;</span><span class="p">];</span>

  <span class="kd">var</span> <span class="nx">VENDOR_PREFIXES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-inkscape&#39;</span><span class="p">];</span>

  <span class="kd">var</span> <span class="nx">SVG_ATTRIBUTES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;clip-rule&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="s1">&#39;fill-opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;fill-rule&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="s1">&#39;font-family&#39;</span><span class="p">,</span> <span class="s1">&#39;font-size&#39;</span><span class="p">,</span> <span class="s1">&#39;font-stretch&#39;</span><span class="p">,</span> <span class="s1">&#39;font-style&#39;</span><span class="p">,</span> <span class="s1">&#39;font-variant&#39;</span><span class="p">,</span> <span class="s1">&#39;font-weight&#39;</span><span class="p">,</span> <span class="s1">&#39;line-height&#39;</span><span class="p">,</span> <span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="s1">&#39;marker-end&#39;</span><span class="p">,</span> <span class="s1">&#39;marker-mid&#39;</span><span class="p">,</span> <span class="s1">&#39;marker-start&#39;</span><span class="p">,</span> <span class="s1">&#39;opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;overflow&#39;</span><span class="p">,</span> <span class="s1">&#39;stop-color&#39;</span><span class="p">,</span> <span class="s1">&#39;stop-opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke-dasharray&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke-dashoffset&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke-linecap&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke-linejoin&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke-miterlimit&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke-opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke-width&#39;</span><span class="p">,</span> <span class="s1">&#39;visibility&#39;</span><span class="p">];</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="nx">styles</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;opacity&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">opacity</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">styles</span><span class="p">[</span><span class="s1">&#39;opacity&#39;</span><span class="p">]);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">opacity</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>if opacity='0' then all fill and stroke properties are useless, remove them</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">styles</span> <span class="o">=</span> <span class="nx">removeStyleProperties</span><span class="p">(</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">union</span><span class="p">(</span><span class="nx">STYLE_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;stroke&#39;</span><span class="p">],</span> <span class="nx">STYLE_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">]));</span>

  <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>if stroke:none, then remove all stroke-related properties (stroke-width, etc)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="nx">styles</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;stroke&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">styles</span><span class="p">[</span><span class="s1">&#39;stroke&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">(</span><span class="nx">STYLE_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;stroke&#39;</span><span class="p">]).</span><span class="nx">without</span><span class="p">(</span><span class="s1">&#39;stroke&#39;</span><span class="p">);</span>
    <span class="nx">styles</span> <span class="o">=</span> <span class="nx">removeStyleProperties</span><span class="p">(</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">_</span><span class="p">(</span><span class="nx">STYLE_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;stroke&#39;</span><span class="p">]).</span><span class="nx">without</span><span class="p">(</span><span class="s1">&#39;stroke&#39;</span><span class="p">));</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>if fill:none, then remove all fill-related properties (fill-rule, etc)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="nx">styles</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">styles</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">styles</span> <span class="o">=</span> <span class="nx">removeStyleProperties</span><span class="p">(</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">_</span><span class="p">(</span><span class="nx">STYLE_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">]).</span><span class="nx">without</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="nx">styles</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;fill-opacity&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">styles</span><span class="p">[</span><span class="s1">&#39;fill-opacity&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">styles</span> <span class="o">=</span> <span class="nx">removeStyleProperties</span><span class="p">(</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">_</span><span class="p">(</span><span class="nx">STYLE_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">]).</span><span class="nx">without</span><span class="p">(</span><span class="s1">&#39;fill-opacity&#39;</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="nx">styles</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;stroke-opacity&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">styles</span><span class="p">[</span><span class="s1">&#39;stroke-opacity&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">styles</span> <span class="o">=</span> <span class="nx">removeStyleProperties</span><span class="p">(</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">_</span><span class="p">(</span><span class="nx">STYLE_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;stroke&#39;</span><span class="p">]).</span><span class="nx">without</span><span class="p">(</span><span class="s1">&#39;stroke-opacity&#39;</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="nx">styles</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;stroke-width&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">styleValue</span><span class="p">(</span><span class="nx">styles</span><span class="p">[</span><span class="s1">&#39;stroke-width&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">styles</span> <span class="o">=</span> <span class="nx">removeStyleProperties</span><span class="p">(</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">_</span><span class="p">(</span><span class="nx">STYLE_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;stroke&#39;</span><span class="p">]).</span><span class="nx">without</span><span class="p">(</span><span class="s1">&#39;stroke-width&#39;</span><span class="p">));</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>scour:</p>

<blockquote>
  <p>remove font properties for non-text elements
  I've actually observed this in real SVG content</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>removes all text styles, if node does not contain text</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">mayContainTextNode</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nx">styles</span> <span class="o">=</span> <span class="nx">removeStyleProperties</span><span class="p">(</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">STYLE_PROPERTIES</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]);</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>changed: removed style properties with a vendor prefix, like
<code>-inkscape-font-specification</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">stylesWithVendorPrefixes</span> <span class="o">=</span> <span class="nx">_</span><span class="p">(</span><span class="nx">styles</span><span class="p">).</span><span class="nx">keys</span><span class="p">().</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">(</span><span class="nx">VENDOR_PREFIXES</span><span class="p">).</span><span class="nx">any</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">styles</span> <span class="o">=</span> <span class="nx">removeStyleProperties</span><span class="p">(</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">stylesWithVendorPrefixes</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>@missing: scour also cleans overflow property</p>

<p>scour:</p>

<blockquote>
  <p>overflow specified on element other than svg, marker, pattern
  it is a marker, pattern or svg
  as long as this node is not the document <svg>, then only
  remove overflow='hidden'.  See 
  http://www.w3.org/TR/2010/WD-SVG11-20100622/masking.html#OverflowProperty</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>scour:</p>

<blockquote>
  <p>now if any of the properties match known SVG attributes we prefer attributes 
  over style so emit them and remove them from the style map</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">styleToAttributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">(</span><span class="nx">styles</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">(</span><span class="nx">SVG_ATTRIBUTES</span><span class="p">).</span><span class="nx">include</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
      <span class="k">delete</span> <span class="nx">styles</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="nx">$node</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="nx">renderStyles</span><span class="p">(</span><span class="nx">styles</span><span class="p">));</span>

<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <h2>Interface</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">defaultOptions</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">styleToAttributes</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>scour:</p>

<blockquote>
  <p>this is the main method
  input is a string representation of the input XML
  returns a string representation of the output XML</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Main processing steps are implemented in SVGCleaner.prototype.clean()</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>This method is to provide a simple interface so one could call
<code>require('scv-clenaer').clean(svg, )</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">clean</span><span class="p">(</span><span class="nx">svgString</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">aSVGCleaner</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SVGCleaner</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
  <span class="nx">aSVGCleaner</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">svgString</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">aSVGCleaner</span><span class="p">.</span><span class="nx">clean</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">clean</span> <span class="o">=</span> <span class="nx">clean</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">cleanFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">clean</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">));</span>
<span class="p">}</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">cleanFile</span> <span class="o">=</span> <span class="nx">cleanFile</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">SVGCleaner</span><span class="p">(</span><span class="nx">_options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">_</span><span class="p">(</span><span class="nx">options</span><span class="p">).</span><span class="nx">extend</span><span class="p">(</span><span class="nx">defaultOptions</span><span class="p">,</span> <span class="nx">_options</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">SVGCleaner</span> <span class="o">=</span> <span class="nx">SVGCleaner</span><span class="p">;</span>

<span class="nx">SVGCleaner</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">load</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">svgString</span><span class="p">)</span><span class="err">Â </span><span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">$</span> <span class="o">=</span> <span class="nx">cheerio</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">svgString</span><span class="p">,</span> <span class="p">{</span> <span class="nx">ignoreWhitespace</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">xmlMode</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">svg</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">html</span><span class="p">();</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <h2>Processing Steps</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">SVGCleaner</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clean</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span><span class="err">Â </span><span class="p">{</span>
  <span class="nx">$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">;</span>
  <span class="nx">removeNamespacedElements</span><span class="p">(</span><span class="nx">namespacePrefixes</span><span class="p">);</span>
  <span class="nx">removeNamespacedAttributes</span><span class="p">(</span><span class="nx">namespacePrefixes</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>@missing remove the xmlns: declarations now</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>@missing ensure namespace for SVG is declared</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>@missing check for redundant SVG namespace declaration</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">removeComments</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>scour:</p>

<blockquote>
  <p>repair style (remove unnecessary style properties and change them into XML attributes)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">repairStyles</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>@missing convert colors to #RRGGBB format</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>@missing remove <metadata> if the user wants to</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>scour:</p>

<blockquote>
  <p>remove unreferenced gradients/patterns outside of defs
  and most unreferenced elements inside of defs</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">removeUnreferencedElements</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>scour:</p>

<blockquote>
  <p>emove empty defs, metadata, g
  NOTE: these elements will be removed if they just have whitespace-only text nodes</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>@extended: also removes nested empty elements <defs><g></g></defs></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">elementWasRemoved</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="nx">elementWasRemoved</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">_</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;defs, metadata, g&#39;</span><span class="p">)).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
        <span class="nx">elementWasRemoved</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nx">elementWasRemoved</span><span class="p">);</span>

  <span class="nx">removeUnreferencedIDs</span><span class="p">();</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">$</span> <span class="o">=</span> <span class="nx">$</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">svg</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">html</span><span class="p">();</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">svg</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>cleanFile('test/files/simple.svg');</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">svg</span> <span class="o">=</span> <span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;&lt;svg&gt; \</span>
<span class="s1">                  &lt;metadata&gt;&lt;/metadata&gt; \</span>
<span class="s1">                  &lt;defs&gt;&lt;g id=&quot;empty&quot;&gt;&lt;/g&gt;&lt;font&gt;&lt;/font&gt;&lt;/defs&gt; \</span>
<span class="s1">                  &lt;g fill=&quot;url(#g)&quot;&gt;&lt;/g&gt; \</span>
<span class="s1">                  &lt;g&gt;    &lt;/g&gt; \</span>
<span class="s1">                  &lt;g&gt;&lt;!-- comment --&gt;&lt;/g&gt; \</span>
<span class="s1">                &lt;/svg&gt;&#39;</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">clean</span><span class="p">(</span><span class="nx">svg</span><span class="p">));</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 